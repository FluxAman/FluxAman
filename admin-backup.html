<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Contact Messages</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 24px;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(56, 189, 248, 0.2);
        }

        .admin-header h1 {
            font-family: 'Outfit', sans-serif;
            font-size: 32px;
            color: var(--text-main);
        }

        .admin-actions {
            display: flex;
            gap: 12px;
        }

        .message-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            padding: 24px;
            border-radius: var(--radius);
            border: 1px solid rgba(56, 189, 248, 0.2);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .message-card:hover {
            border-color: rgba(56, 189, 248, 0.4);
            box-shadow: 0 0 30px rgba(56, 189, 248, 0.2);
        }

        .message-card.unread {
            border-left: 4px solid var(--accent);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }

        .message-info h3 {
            color: var(--text-main);
            margin: 0 0 8px 0;
            font-size: 18px;
        }

        .message-info p {
            color: var(--text-muted);
            margin: 0;
            font-size: 14px;
        }

        .message-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            background: rgba(56, 189, 248, 0.1);
            border: 1px solid rgba(56, 189, 248, 0.2);
            color: var(--accent);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .icon-btn:hover {
            background: rgba(56, 189, 248, 0.2);
            border-color: var(--accent);
        }

        .icon-btn.delete {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.2);
        }

        .icon-btn.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
        }

        .message-body {
            color: var(--text-main);
            line-height: 1.6;
            padding: 16px;
            background: rgba(10, 15, 31, 0.5);
            border-radius: 8px;
            margin-top: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 80px 24px;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            padding: 20px;
            border-radius: var(--radius);
            border: 1px solid rgba(56, 189, 248, 0.2);
            text-align: center;
        }

        .stat-card h2 {
            font-family: 'Outfit', sans-serif;
            font-size: 36px;
            color: var(--accent);
            margin: 0 0 8px 0;
        }

        .stat-card p {
            color: var(--text-muted);
            margin: 0;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="admin-container">
        <div class="admin-header">
            <div>
                <h1><i class="fas fa-envelope"></i> Contact Messages</h1>
                <p style="color: var(--text-muted); margin: 8px 0 0 0;">Manage your portfolio contact form submissions
                </p>
            </div>
            <div class="admin-actions">
                <button class="btn ghost" onclick="exportToCSV()">
                    <i class="fas fa-download"></i> Export CSV
                </button>
                <button class="btn ghost" onclick="clearAll()">
                    <i class="fas fa-trash"></i> Clear All
                </button>
                <a href="index.html" class="btn">
                    <i class="fas fa-home"></i> Back to Site
                </a>
            </div>
        </div>

        <div class="stats" id="stats"></div>

        <div id="messages-container"></div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal"
        style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 1000; justify-content: center; align-items: center;">
        <div
            style="background: var(--bg-card); padding: 40px; border-radius: 16px; border: 1px solid rgba(56, 189, 248, 0.3); width: 100%; max-width: 400px; text-align: center;">
            <i class="fas fa-lock" style="font-size: 48px; color: var(--accent); margin-bottom: 24px;"></i>
            <h2 style="color: var(--text-main); margin: 0 0 24px 0;">Admin Login</h2>
            <form id="login-form">
                <input type="password" id="admin-password" placeholder="Enter Password" required
                    style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; margin-bottom: 24px; font-size: 16px;">
                <button type="submit" class="btn" style="width: 100%;">Login</button>
            </form>
            <p id="login-error" style="color: #ef4444; margin: 16px 0 0 0; display: none;">Incorrect password</p>
        </div>
    </div>

    <script>
        const API_URL = '/api/messages';
        const loginModal = document.getElementById('login-modal');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const passwordInput = document.getElementById('admin-password');

        // Check if logged in
        function checkAuth() {
            const password = sessionStorage.getItem('adminPassword');
            if (password) {
                loginModal.style.display = 'none';
                loadMessages();
            } else {
                loginModal.style.display = 'flex';
            }
        }

        // Handle Login
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const password = passwordInput.value;
            // Simple validation before real check
            if (password) {
                sessionStorage.setItem('adminPassword', password);
                loadMessages(); // Will trigger 401 if wrong
            }
        });

        async function fetchWithAuth(url, options = {}) {
            const password = sessionStorage.getItem('adminPassword');
            const headers = {
                ...options.headers,
                'Content-Type': 'application/json',
                'x-admin-password': password
            };

            const response = await fetch(url, { ...options, headers });

            if (response.status === 401) {
                sessionStorage.removeItem('adminPassword');
                loginModal.style.display = 'flex';
                loginError.style.display = 'block';
                loginError.textContent = 'Incorrect password or session expired';
                passwordInput.value = '';
                throw new Error('Unauthorized');
            }

            return response;
        }

        async function loadMessages() {
            const container = document.getElementById('messages-container');
            const statsContainer = document.getElementById('stats');

            try {
                const response = await fetchWithAuth(API_URL);
                let messages = await response.json();

                // Login successful if we get here
                loginModal.style.display = 'none';
                loginError.style.display = 'none';

                // Update stats
                const totalMessages = messages.length;
                const unreadMessages = messages.filter(m => !m.read).length;
                const todayMessages = messages.filter(m => {
                    const msgDate = new Date(m.timestamp).toDateString();
                    const today = new Date().toDateString();
                    return msgDate === today;
                }).length;

                statsContainer.innerHTML = `
            <div class="stat-card">
              <h2>${totalMessages}</h2>
              <p>Total Messages</p>
            </div>
            <div class="stat-card">
              <h2>${unreadMessages}</h2>
              <p>Unread</p>
            </div>
            <div class="stat-card">
              <h2>${todayMessages}</h2>
              <p>Today</p>
            </div>
          `;

                if (messages.length === 0) {
                    container.innerHTML = `
              <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <h2>No messages yet</h2>
                <p>Contact form submissions will appear here</p>
              </div>
            `;
                    return;
                }

                // Sort by newest first
                messages.sort((a, b) => b.id - a.id);

                container.innerHTML = messages.map(msg => `
            <div class="message-card ${msg.read ? '' : 'unread'}">
              <div class="message-header">
                <div class="message-info">
                  <h3>${msg.name}</h3>
                  <p><i class="fas fa-envelope"></i> ${msg.email}</p>
                  <p><i class="fas fa-clock"></i> ${msg.timestamp}</p>
                </div>
                <div class="message-actions">
                  <button class="icon-btn" onclick="toggleRead(${msg.id})" title="${msg.read ? 'Mark as unread' : 'Mark as read'}">
                    <i class="fas fa-${msg.read ? 'envelope-open' : 'envelope'}"></i>
                  </button>
                  <button class="icon-btn" onclick="replyTo('${msg.email}')" title="Reply">
                    <i class="fas fa-reply"></i>
                  </button>
                  <button class="icon-btn delete" onclick="deleteMessage(${msg.id})" title="Delete">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
              <div class="message-body">
                ${msg.message}
              </div>
            </div>
          `).join('');
            } catch (error) {
                console.error('Error loading messages:', error);
                // Only show error if not auth error (handled in fetchWithAuth)
                if (error.message !== 'Unauthorized') {
                    container.innerHTML = '<p style="text-align:center; color:red;">Failed to load messages. Is server running?</p>';
                }
            }
        }

        async function toggleRead(id) {
            try {
                const response = await fetchWithAuth(`${API_URL}/${id}/read`, {
                    method: 'PATCH'
                });
                if (response.ok) {
                    loadMessages();
                }
            } catch (error) {
                console.error('Error toggling status:', error);
            }
        }

        async function deleteMessage(id) {
            if (confirm('Are you sure you want to delete this message?')) {
                try {
                    const response = await fetchWithAuth(`${API_URL}/${id}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        loadMessages();
                    }
                } catch (error) {
                    console.error('Error deleting message:', error);
                }
            }
        }

        function replyTo(email) {
            window.location.href = `mailto:${email}`;
        }

        async function clearAll() {
            alert('To clear all, please delete messages individually or clear the messages.json file on server.');
        }

        function exportToCSV() {
            // Re-fetch to get data for export
            fetchWithAuth(API_URL)
                .then(res => res.json())
                .then(messages => {
                    if (messages.length === 0) {
                        alert('No messages to export');
                        return;
                    }

                    const csv = [
                        ['Timestamp', 'Name', 'Email', 'Message', 'Read'],
                        ...messages.map(m => [
                            m.timestamp,
                            m.name,
                            m.email,
                            `"${m.message.replace(/"/g, '""')}"`,
                            m.read ? 'Yes' : 'No'
                        ])
                    ].map(row => row.join(',')).join('\n');

                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `contact-messages-${new Date().toISOString().split('T')[0]}.csv`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                });
        }

        // Initialize
        checkAuth();

        // Refresh every 30 seconds
        setInterval(() => {
            if (sessionStorage.getItem('adminPassword')) {
                loadMessages();
            }
        }, 30000);
    </script>
</body>

</html>